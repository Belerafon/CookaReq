# Миграция истории агента

Начиная с версии приложения, в которой появилась эта инструкция, история
агентского чата хранится только в формате **версии 2**. Каждая запись в
разговорах содержит обязательный блок `token_info`, и приложение отказывается
загружать файлы с другими версиями или без этого поля. Это позволяет упростить
код загрузки, избежать теневых миграций во время запуска и гарантировать, что в
GUI всегда доступны корректные сведения о количестве токенов.

С этого же релиза `ChatEntry` дополнительно сохраняет словарь `token_cache` —
он содержит хэши текста промпта/ответа и кэшированные значения
`TokenCountResult` по каждому LLM. Записи, созданные ранее и не имеющие этого
поля, остаются валидными: приложение заполнит кэш в памяти и сохранит его при
следующем обновлении истории.

Если у вас сохранились архивы с более старыми форматами, их нужно конвертировать
перед запуском приложения. Для этого в репозитории добавлена утилита
`tools/migrate_agent_history.py`.

## Поддерживаемые варианты исходных файлов

Скрипт понимает два основных типа легаси-структур:

1. **Файлы версии 2 без `token_info`**. В таких записях поле `tokens` могло
   заполняться вручную, а метаданные по токенам отсутствуют. Утилита пересчитывает
   статистику по тексту и дописывает блок `token_info` в каждую запись.
2. **Плоский список словарей** без обёртки `{"version": ..., "conversations": ...}`.
   Скрипт создает новую беседу, переносит записи в неё и вычисляет недостающие
   поля. Активной беседой становится последняя успешная.

Файлы с неизвестной версией (например, `version: 3`) обрабатываться не будут —
утилита завершится с ошибкой, чтобы избежать повреждения данных.

## Как пользоваться

```bash
python3 tools/migrate_agent_history.py /путь/к/history.json
```

По умолчанию результат сохраняется в соседнем файле с суффиксом `.migrated`
(например, `history.migrated.json`). Чтобы переписать файл на месте и одновременно
получить резервную копию, используйте флаг `--in-place`:

```bash
python3 tools/migrate_agent_history.py /путь/к/history.json --in-place
```

Резервная копия сохраняется рядом с исходником и получает расширение `.bak`.
Путь можно задать явно через `--backup`, а перезаписывать существующие файлы —
флагом `--force`.

После миграции убедитесь, что приложение стартует и корректно отображает историю
(в окне должна появиться лента чата без сообщений о несовместимом формате).
Если требуется откат, замените `history.json` на резервную копию и повторите
миграцию, разобравшись с сообщением об ошибке.

## Известные ограничения

- В старых форматах не хранились временные метки бесед, поэтому при миграции
  скрипт восстанавливает `created_at` и `updated_at` по первым доступным
  значениям `prompt_at`/`response_at`. Если они отсутствуют, используются
  текущие значения на момент конвертации.
- При обработке сильно поврежденных файлов (например, где сообщения не являются
  словарями) утилита пропустит некорректные элементы. Если в результате не
  останется ни одной валидной записи, будет сгенерировано исключение.
- Скрипт не модифицирует значения `raw_result` и `tool_results`, а лишь переносит
  их как есть. Если структура этих полей изменилась между версиями, проверьте
  результат вручную.

## Тестирование и сопровождение

- Перед релизом новых версий истории запускайте модульные тесты GUI: они
  проверяют, что приложение корректно отклоняет устаревшие файлы и не выполняет
  скрытых миграций.
- При расширении формата истории обновляйте как код загрузки, так и эту
  инструкцию — пользователи должны заранее знать, как подготовить данные.
