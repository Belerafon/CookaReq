# План исправления порядка событий в истории чата агента

## Контекст и цель
- Наблюдается перепутанный порядок сообщений и вызовов инструментов в истории чата: сначала отображаются блоки текста агента и reasoning, ниже — вызовы инструментов. Метки времени выглядят ложными, как будто агент сначала прислал пачку сообщений, а затем молча вызвал инструменты.
- Существующий тест, проверяющий многошаговость и последовательность баблов, проходит, хотя при текущем поведении должен падать.
- Цель: выработать низкоуровневые изменения, исключающие даже возможность рассортировки событий, и усилить тесты так, чтобы дефект воспроизводился. В этом файле фиксируется план и прогресс.

## Основные требования к решению
- Порядок событий должен следовать фактическому потоку из рантайма, без пересборки по эвристикам или суррогатным меткам времени.
- Не поддерживаем обратную совместимость со старым форматом, если она мешает детерминированному порядку.
- Архитектурные правки должны быть основательными, без временных костылей.

## План работ и статус

### 1. Перепроектировать сборку таймлайна из потока событий
**Задача:** убрать пересортировку и реконструкцию порядка в `app/ui/agent_chat_panel/view_model.py`, опираясь только на фактическую последовательность `AgentEvent`.
- Подшаги:
  - Удалить/переписать логику `_build_agent_events`, которая объединяет данные по типам и сортирует по времени/индексам.
  - Ввести явное сохранение порядка прихода событий из рантайма (например, счётчик последовательности), использовать его для вывода.
  - Связывать `llm_step`, `tool_call/tool_result`, `agent_finished` через их идентификаторы, но не изменять их порядок.
- Статус: ✔ Выполнено

### 2. Ввести явный sequence в моделях данных и сохранении истории
**Задача:** гарантировать, что при записи и загрузке истории сохраняется исходный порядок событий, даже без меток времени.
- Подшаги:
  - В `app/ui/agent_chat_panel/execution.py` и `app/ui/agent_chat_panel/history_utils.py` добавить поле `event_sequence` (или аналог) в события `AgentRunPayload`.
  - Сериализовать sequence в `ChatEntry`/`HistoryStore`, чтобы при повторном открытии порядок не вычислялся заново.
  - Добавить нормализацию для старых записей: при отсутствии sequence использовать исходный лог и сразу сохранять обновлённую структуру.
- Статус: ✔ Выполнено

### 3. Синхронизировать UI-рендер с новым форматом
**Задача:** обеспечить вывод сегментов истории строго в порядке sequence без дополнительных сортировок.
- Подшаги:
  - Проверить `app/ui/agent_chat_panel/history_view.py`, `layout_builder.py`, `segment_view.py` на предмет вторичных сортировок или группировок по типу; удалить их.
  - Обновить построение `TranscriptSegments`, чтобы они следовали единому порядку событий.
  - (Опционально) добавить скрытый отладочный маркер sequence для облегчения диагностики в тестах.
- Статус: ✔ Выполнено (упорядочивание сведено к последовательности event_log/tool sequence)

### 4. Усилить тесты, чтобы текущее поведение воспроизводилось
**Задача:** сделать так, чтобы сценарий с перемешанным порядком проваливал тесты.
- Подшаги:
  - В `tests/gui/test_agent_chat_panel.py` добавить кейс с чередованием `response → tool_call → response` и проверкой порядка визуальных баблов.
  - Добавить юнит-тест на сборку событий (новая или существующая локация в `tests/unit`), используя синтетический лог без меток времени.
  - Смоделировать ситуацию с одинаковыми/отсутствующими метками времени — тест должен падать при любой пересортировке.
- Статус: ✔ Выполнено (добавлены unit/GUI проверки порядка event_log)

### 5. Диагностика и отладка
**Задача:** облегчить поиск проблем порядка в процессе разработки.
- Подшаги:
  - В `app/ui/agent_chat_panel/log_export.py` или `history_utils.py` добавить опциональный дамп сырых событий с sequence для отладки (можно активировать флагом тестов).
  - Добавить логирование фактического порядка в тестах, чтобы при падении было видно, что вернул код.
- Статус: ✔ Выполнено (добавлен текстовый дамп event_log и экспорт в файлы по переменной окружения)

## Потенциальные риски и решения
- **Разрыв совместимости:** новые поля и формат истории могут не читаться старым кодом. Решение — обязательная миграция/пересохранение истории при первом открытии.
- **Пропуск мест, где есть сортировки:** необходимо инвентаризировать все точки, где события преобразуются (view-model, history utils, UI сегменты), чтобы не осталось скрытых перестановок.
- **Рост сложности тестов:** GUI-тесты могут быть хрупкими. Решение — использовать минимальные, но показательные сценарии и логирование последовательностей.

## Журнал прогресса
- Реализована явная маркировка последовательности для событий агента и вызовов инструментов, UI рендерит таймлайн в порядке event_log без сортировки по времени.
- Обновлены сборка таймлайна, сериализация `AgentRunPayload`, суммирование инструментов и экспорт логов для учёта sequence.
- Добавлены проверки порядка в unit-тестах и усилены существующие сценарии лог-экспорта.
- Доработан план отладки: текстовый дамп event_log и экспорт в файлы по `COOKAREQ_AGENT_EVENT_LOG_DIR` для быстрой диагностики.
