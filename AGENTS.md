# AGENTS

Этот файл содержит инструкции и краткую архитектуру приложения "CookaReq".

## Общие инструкции
- Работать в основной ветке (без новых веток).
- Перед каждым коммитом выполнять `pytest`.
- Тесты, использующие `wx`, должны запускаться в виртуальном дисплее
  (плагин `pytest-xvfb` или обёртка `xvfb-run -a`).
- Для сборки и тестов использовать системный Python 3.12.3.
  В корне лежит файл `.python-version` со значением `system`, поэтому
  `pyenv` переключается автоматически; запускать команды следует через `python3`.
  Команда `python` отсутствует, используйте `python3`.
- Ключ OpenRouter хранится в файле `.env` в переменной `OPEN_ROUTER`.
  По умолчанию тесты используют мок LLM и не обращаются к внешнему API.
  Чтобы задействовать реальный OpenRouter в интеграционных тестах,
  установите `OPENROUTER_REAL=1` и убедитесь, что `OPEN_ROUTER`
  содержит валидный ключ.

## Архитектура

### Слои и модули

#### Точка входа
- `app/main.py` — запуск графического приложения и создание главного окна.
- `app/cli/main.py` — консольный интерфейс: работа с требованиями и проверка настроек (запуск через `python3 -m app.cli`).

#### Настройки и конфигурация
- `app/settings.py` — Pydantic‑модели `LLMSettings`, `MCPSettings`, `UISettings` и агрегирующий `AppSettings`.
- `app/config.py` — обёртка над `wx.Config` с typed‑хелперами.

#### Бизнес-логика (`app/core`)
- `model.py` — dataclass `Requirement` и перечисления статусов.
- `schema.py` — JSON Schema для требований.
- `validate.py` — проверка бизнес-правил (уникальность id, обязательные поля).
- `labels.py` — предустановленные наборы меток и CRUD-операции в памяти.
- `store.py` — низкоуровневое чтение/запись JSON и генерация имён по идентификатору.
- `requirements.py` — высокоуровневые операции загрузки, поиска и сохранения.
- `repository.py` — интерфейс `RequirementRepository` и файловая реализация.
- `search.py` — фильтрация по меткам, статусу и текстовый поиск.

#### Сервисы и инфраструктура
- `app/agent/local_agent.py` — комбинирует LLM и MCP-клиенты, предоставляя высокоуровневые операции.
- `app/llm` — интеграция с LLM: `LLMClient` и описание схемы инструментов (`spec.py`).
- `app/mcp` — HTTP‑сервер/клиент MCP и набор инструментов:
  `server.py`, `tools_read.py`, `tools_write.py`, `client.py`, `utils.py`.
- `app/mcp/controller.py` — запуск и мониторинг MCP‑сервера.
- `app/log.py` — настройка логирования и JSONL‑обработчик.
- `app/telemetry.py` — единая точка логирования с редактированием чувствительных данных.
- `app/confirm.py` — регистрация и вызов функций подтверждения действий.
- `app/i18n.py` — загрузка переводов из `.po`‑файлов.
- `app/resources/` — статические файлы (иконки и пр.).

#### Пользовательский интерфейс (`app/ui`)
- `main_frame.py` — основное окно, меню, выбор папки.
- `list_panel.py` — список требований и фильтры/поиск.
- `editor_panel.py` — форма редактирования требований.
- `command_dialog.py` — ввод команд для `LocalAgent`.
- `settings_dialog.py` — редактирование настроек LLM/MCP/UI.
- `labels_dialog.py` — управление набором меток.
- `label_selection_dialog.py` — выбор меток из пресетов.
- `filter_dialog.py` — расширенные фильтры поиска.
- `derivation_graph.py` — граф отображения зависимых требований.
- `navigation.py` — навигация по связям требований.
- `requirement_model.py` — in-memory модель с фильтрацией и сортировкой.
- `locale.py` — словарь кодов ↔ русский текст.
- `controllers/requirements.py` — загрузка и CRUD‑операции над требованиями.
- `controllers/labels.py` — управление метками и синхронизация с требованиями.

#### Утилиты
- `app/util/hashing.py` — преобразование id в короткий SHA‑256 хэш.
- `app/util/paths.py` — работа с относительными путями.


#### Сборка
- `build.py` — упаковка проекта через PyInstaller (one-folder).

### Связи между слоями
- GUI (`app/ui`) обращается к контроллерам, которые взаимодействуют с сервисами и модулем `app/core`.
- `LocalAgent` использует `LLMClient` и `MCPClient`; последний вызывает инструменты MCP‑сервера, работающие поверх хранилища требований.
- Бизнес‑логика (`app/core`) оперирует файлами JSON на диске, выступая слоем хранилища.

### Порядок запуска
1. `main.py` настраивает логирование и конфигурацию, инициализирует локализацию.
2. Создаётся модель требований и основной `MainFrame`.
3. При необходимости пользователь запускает MCP‑сервер через `MCPController` или обращается к `LocalAgent` из GUI/CLI.

### Точки расширения
- Добавление новых MCP‑инструментов в `app/mcp/tools_*` и соответствующих схем в `app/llm/spec.py`.
- Расширение телеметрии через новые события в `log_event`.
- Внедрение новых панелей/диалогов в `app/ui` и соответствующих контроллеров.
- Подмена хранилища, реализовав альтернативы `app/core/store.py`.
 
## Сборка

Для создания Windows-сборки используется PyInstaller. Важно собирать в том же
окружении, где установлены все зависимости (wxPython и jsonschema), иначе в
сборку не попадут нужные пакеты.

1) Подготовьте окружение

```bash
python3 -m venv .venv
source .venv/bin/activate  # в Windows: .venv\Scripts\activate
pip install -r requirements.txt
pip install pyinstaller
```

2) Соберите приложение (режим one-folder по умолчанию)

```bash
python3 build.py
```

Готовые файлы появятся в каталоге `dist/CookaReq`. Этот вариант
самодостаточный: папка содержит все нужные DLL/библиотеки.

3) Альтернатива: один файл (one-file)

```bash
python3 build.py --onefile
```

Будет создан `CookaReq.exe`, который при запуске распаковывается во временную
папку. Такой EXE также самодостаточный и не зависит от установленных модулей в
системе.

Примечание: если при запуске EXE видите `ModuleNotFoundError: No module named 'wx'`,
значит wxPython не был установлен в окружении, в котором выполнялся `build.py`.
Убедитесь, что выполняли сборку из активированного venv с установленными
зависимостями (см. шаг 1).

## Тестирование

Чтобы прогонять тесты GUI без сборки wxPython из исходников, установите
готовые пакеты и зависимости из репозиториев Ubuntu:

```bash
apt-get update && apt-get install -y \
    python3-wxgtk4.0 python3-pip xvfb xauth
python3 -m venv .venv --system-site-packages
source .venv/bin/activate
pip install pytest pytest-xvfb jsonschema
pytest -q
```

`pytest-xvfb` автоматически поднимает виртуальный дисплей, поэтому окна не
появятся и тесты выполняются в headless-режиме.

Для запусков вне `pytest` (отдельные скрипты или интеграционные проверки),
оборачивайте команду в `xvfb-run -a`, например:

```bash
xvfb-run -a python3 script.py
```

## Локализация

Переводы хранятся в текстовых `.po`‑файлах и загружаются приложением напрямую.
Бинарные `.mo`‑каталоги и утилита `msgfmt` больше не требуются.

## Журнал выполнения
- 2025-09-10: Сформирован первоначальный план разработки (устарел).
- 2025-09-10: Создан каркас проекта.
- 2025-09-10: Добавлены утилиты.
- 2025-09-10: Реализована модель требований, схема и бизнес-валидация.
- 2025-09-10: Добавлены `.gitignore` и `pytest.ini`.
- 2025-09-11: Реализовано хранилище JSON.
- 2025-09-11: Реализованы поиск и фильтры.
- 2025-09-11: Создан каркас GUI.
- 2025-09-11: Реализован редактор требований.
- 2025-09-11: Добавлена локализация.
- 2025-09-12: Подключён словарь локализации.
- 2025-09-13: Добавлен скрипт сборки PyInstaller и инструкции.
- 2025-09-14: Удалён файл `Plan.md`; AGENTS.md переписан с актуальной архитектурой.
- 2025-09-15: Добавлены `LocalAgent`, LLM-клиент, MCP-сервер/клиент и модуль телеметрии.
- 2025-09-15: Введены контроллеры и система настроек приложения.
