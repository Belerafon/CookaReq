# Подсистемы и слои CookaReq

> Черновой каркас: структура разделов и список вопросов, которые нужно закрыть при наполнении.

## 1. Карта слоёв
- [ ] Кратко описать слои (GUI, ядро/Document Store, агент, MCP, CLI, общие сервисы).
- [ ] Зафиксировать правила взаимодействия между слоями и допустимые зависимости.
- [ ] Продумать формат диаграммы (текстовая матрица/Graphviz) и отметить её местоположение.

## 2. GUI
- [ ] Сформулировать ответственность GUI и границы по отношению к ядру.
- [ ] Выделить ключевые контроллеры/панели и их API.
- [ ] Описать взаимодействия с агентом и document_store.
- [x] Реализован диалог `RequirementImportDialog` для импорта CSV/Excel: пользователь настраивает разделитель, сопоставляет колонки полям требований, видит предпросмотр и передаёт результат `MainFrameDocumentsMixin` для сохранения.

### Batch-режим панели агента

- `AgentChatPanel` создаёт `AgentBatchRunner`, который управляет очередью
  требований и последовательно вызывает `AgentRunController`. Runner получает
  `BatchTarget` (RID, id, заголовок) и для каждого шага создаёт новый
  `ChatConversation` без повторного подтягивания прошлой истории.
- `MainFrameAgentMixin` предоставляет `_agent_batch_targets()` и
  `_agent_context_for_requirement()`, формируя список требований и точечный
  системный контекст по каждому из них. Оба колбэка передаются в
  `AgentChatPanel` при инициализации.
- Внизу панели появляется блок «Batch queue» с прогресс-баром и таблицей
  состояний (`pending`, `running`, `completed`, `failed`, `cancelled`) и
  кнопками «Run batch»/«Stop batch». Очередь показывает ход выполнения и
  скрывается, когда список пуст.
- Метод `_finalize_prompt()` и обработчик отмены `_finalize_cancelled_run()`
  уведомляют `AgentBatchRunner` о результате шага, чтобы перейти к следующему
  требованию или корректно завершить пакет.

## 3. Ядро и хранилище требований
- [ ] Рассказать про модели требований, сервисы document_store, правила ревизий.
- [ ] Зафиксировать публичные точки расширения (новые типы документов, плагины).
- [ ] Обозначить зависимости от файловой системы и конфигурации.

## 4. Агент и LLM
- [ ] Описать `LocalAgent`, планировщик операций, использование LLM.
- [ ] Указать, как агент обращается к MCP и document_store.
- [ ] Собрать риски и TODO (например, ограничения потоков, обработка длинных операций).

### Контекстные подсказки агента

- `LocalAgent._prepare_context_messages_async()` нормализует системный контекст и
  передаёт его в `_enrich_workspace_context_async()`, чтобы дополнить блок
  `[Workspace context]` краткими выдержками из выбранных требований. Метод
  разбирает строку `Selected requirement RIDs:` и игнорирует некорректные RID,
  сохраняя порядок валидных идентификаторов.
- `_enrich_workspace_context_async()` собирает новые описания в один запрос к
  MCP: `_fetch_requirement_summaries_async()` вызывает инструмент
  `get_requirement`, передавая список RID и набор полей (`title`, `statement`).
  MCP возвращает массив объектов, после чего агент добавляет строки `RID —
  summary`, пропуская уже присутствующие записи. Повторяющиеся идентификаторы
  фильтруются до обращения к MCP, поэтому инструмент вызывается не более одного
  раза на контекстное сообщение.
- При ошибке вызова MCP или некорректном ответе обогащение контекста
  пропускается, чтобы не блокировать основной сценарий. Стоит рассмотреть
  телеметрию для таких отказов, если обогащение станет критичным для UX.

## 5. MCP и инструменты
- [ ] Дать обзор MCP-сервера, зарегистрированных инструментов и их контрактов.
- [ ] Отметить жизненный цикл инструментов, обработку ошибок и логи.
- [ ] Сформировать список мест в коде, откуда подключаются новые инструменты.

## 6. CLI
- [ ] Объяснить, как CLI переиспользует ядро и сервисы.
- [ ] Выделить основные команды и точки расширения.
- [ ] Зафиксировать особенности окружения (запуск без GUI, конфигурация).
- [x] Отметить экспорт требований: команда `python3 -m app.cli export requirements` собирает данные через
      `app/core/requirement_export.py` и выдаёт Markdown/HTML/PDF-отчёты с кликабельными ссылками между RID.

## 7. Общие сервисы
- [ ] Список вспомогательных модулей (конфиг, локализация, логирование, плагины).
- [ ] Прописать зависимости и правила использования.
- [ ] Выделить потенциальные зоны рефакторинга.

## 8. Сценарии взаимодействия
- [ ] Подготовить 2–3 ключевых сквозных сценария (открытие проекта, правка требования, построение отчёта).
- [ ] Для каждого сценария описать последовательность взаимодействий между слоями.
- [ ] Определить, нужны ли диаграммы последовательностей или таблицы.

## 9. Риски и задачи
- [ ] Собрать список выявленных проблем и решений.
- [ ] Зафиксировать идеи для автоматизации (генерация диаграмм, проверка зависимостей).

> После заполнения раздела проверить, что системный контекст и данные/конфигурации содержат соответствующие ссылки.
