# Данные и конфигурация CookaReq

> Черновой каркас: перечисляет вопросы, на которые нужно ответить при описании данных и настроек.

## 1. Хранилище требований
- [ ] Описать структуру каталога `requirements/` и вспомогательных директорий.
- [ ] Зафиксировать формат RID-файлов, правила именования, версионирование.
- [ ] Уточнить механизм загрузки/сохранения (document_store, кэширование, обработка конфликтов).

## 2. Доменные модели и схемы
- [ ] Собрать список ключевых Pydantic-моделей и их поля.
- [ ] Для каждой модели указать инварианты и правила валидации.
- [ ] Описать связь моделей с UI и MCP инструментами.

## 3. Конфигурация приложения
- [ ] Перечислить источники настроек (файлы, переменные окружения, GUI).
- [ ] Определить приоритеты и правила переопределения.
- [ ] Зафиксировать чувствительные параметры (LLM ключи, пути к проекту).

## 4. Конфигурация агента и MCP
- [ ] Описать настройки LLM-клиента, режимы работы, лимиты.
- [ ] Рассказать о конфигурации MCP-сервера и инструментах.
- [ ] Сформировать таблицу зависимостей между настройками и функциональностью.

### Параметры агента

- `agent.max_consecutive_tool_errors` — ограничение на количество подряд
  неуспешных вызовов MCP-инструментов. Значение по умолчанию равно 5, что
  позволяет LLM увидеть ответ с кодом ошибки и скорректировать аргументы.
  Неположительные значения и `null` отключают отсечку, перенося контроль на
  лимит шагов (`agent.max_thought_steps`).
- В каталоге требований создаётся поддиректория `.cookareq` с файлом
  `agent_settings.json`. В нём хранится пользовательский системный промпт,
  дописываемый к базовому тексту агента только для выбранного проекта. Файл
  записывается рядом с историей чата (`agent_chats.json`) и позволяет хранить
  специфичные требования (термины, правила оформления) вместе с
  репозиторием требований. Активная беседа сохраняется в отдельном
  сайдкар-файле `agent_chats_active.json`, чтобы при переключении между
  диалогами не приходилось сериализовывать всю историю целиком.
  В `agent_chats.json` каждая запись (`ChatEntry`) теперь включает дополнительное
  поле `reasoning`: массив словарей вида `{ "type": str, "text": str }`, где
  сохраняются скрытые мысли модели (CoT), поступающие от Reasoning-моделей
  OpenAI/Qwen. Эти сегменты не попадают в основной ответ, но отображаются в GUI
  в отдельной сворачиваемой панели «Model reasoning», чтобы оператор мог
  посмотреть ход рассуждений и отладить ошибочные шаги.
- `llm.message_format` — режим кодирования диалогов при обращении к модели.
  На форме настроек доступен классический формат OpenAI (`openai-chat`),
  Harmony (`harmony`) для GPT-OSS и свежая интеграция Qwen (`qwen`). Режим
  Qwen формирует ChatML-подобные сообщения, поддерживает Reasoning-модели с
  полем `reasoning_content` и извлекает вызовы MCP-инструментов даже когда они
  генерируются в ходе «мысленного» шага. Harmony использует собственный
  рендерер: системный промпт, инструкции и JSON-схемы MCP-инструментов
  преобразуются в Harmony-последовательность, после чего клиент вызывает
  Responses API и разбирает блоки `message` и `function_call`, скрывая CoT от
  пользователя. Потоковый режим реализован через `responses.stream`, поэтому
  Harmony реагирует на отмену запросов так же, как и остальные форматы, без
  блокирующих fallback-запросов.
- `llm.use_custom_temperature` и `llm.temperature` — пара настроек, управляющих
  передачей параметра `temperature` в OpenAI-совместимый API. По умолчанию
  чекбокс отключён, и клиент вовсе не отправляет значение температуры, чтобы
  провайдер применял собственные дефолты. Если пользователь активирует опцию,
  в GUI становится доступен `SpinCtrlDouble` с диапазоном 0–2 (шаг 0.1) и
  дефолтным значением 0.7. Клиент LLM учитывает это значение во всех запросах
  (включая health-check) и пропускает параметр, когда чекбокс снят.

## 5. Управление данными и миграции
- [ ] Выписать процессы резервного копирования и восстановления.
- [ ] Описать стратегии миграции схем (изменение структуры требований, обновление конфигов).
- [ ] Собрать известные проблемы (например, ручное слияние конфликтов).

## 6. Наблюдаемость данных
- [ ] Где логируются операции с данными и конфигурацией.
- [ ] Какие проверки и валидации выполняются автоматически.
- [ ] TODO на улучшение мониторинга и диагностики.

> При наполнении раздела свериться с `integrations.md`, чтобы не дублировать описания внешних сервисов.
