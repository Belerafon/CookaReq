# Подсистемы и слои CookaReq

> Черновой каркас: структура разделов и список вопросов, которые нужно закрыть при наполнении.

## 1. Карта слоёв
- [ ] Кратко описать слои (GUI, ядро/Document Store, агент, MCP, CLI, общие сервисы).
- [ ] Зафиксировать правила взаимодействия между слоями и допустимые зависимости.
- [ ] Продумать формат диаграммы (текстовая матрица/Graphviz) и отметить её местоположение.

## 2. GUI
- [ ] Сформулировать ответственность GUI и границы по отношению к ядру.
- [ ] Выделить ключевые контроллеры/панели и их API.
- [ ] Описать взаимодействия с агентом и document_store.

### Batch-режим панели агента

- `AgentChatPanel` создаёт `AgentBatchRunner`, который управляет очередью
  требований и последовательно вызывает `AgentRunController`. Runner получает
  `BatchTarget` (RID, id, заголовок) и для каждого шага создаёт новый
  `ChatConversation` без повторного подтягивания прошлой истории.
- `MainFrameAgentMixin` предоставляет `_agent_batch_targets()` и
  `_agent_context_for_requirement()`, формируя список требований и точечный
  системный контекст по каждому из них. Оба колбэка передаются в
  `AgentChatPanel` при инициализации.
- Внизу панели появляется блок «Batch queue» с прогресс-баром и таблицей
  состояний (`pending`, `running`, `completed`, `failed`, `cancelled`) и
  кнопками «Run batch»/«Stop batch». Очередь показывает ход выполнения и
  скрывается, когда список пуст.
- Метод `_finalize_prompt()` и обработчик отмены `_finalize_cancelled_run()`
  уведомляют `AgentBatchRunner` о результате шага, чтобы перейти к следующему
  требованию или корректно завершить пакет.

## 3. Ядро и хранилище требований
- [ ] Рассказать про модели требований, сервисы document_store, правила ревизий.
- [ ] Зафиксировать публичные точки расширения (новые типы документов, плагины).
- [ ] Обозначить зависимости от файловой системы и конфигурации.

## 4. Агент и LLM
- [ ] Описать `LocalAgent`, планировщик операций, использование LLM.
- [ ] Указать, как агент обращается к MCP и document_store.
- [ ] Собрать риски и TODO (например, ограничения потоков, обработка длинных операций).

## 5. MCP и инструменты
- [ ] Дать обзор MCP-сервера, зарегистрированных инструментов и их контрактов.
- [ ] Отметить жизненный цикл инструментов, обработку ошибок и логи.
- [ ] Сформировать список мест в коде, откуда подключаются новые инструменты.

## 6. CLI
- [ ] Объяснить, как CLI переиспользует ядро и сервисы.
- [ ] Выделить основные команды и точки расширения.
- [ ] Зафиксировать особенности окружения (запуск без GUI, конфигурация).

## 7. Общие сервисы
- [ ] Список вспомогательных модулей (конфиг, локализация, логирование, плагины).
- [ ] Прописать зависимости и правила использования.
- [ ] Выделить потенциальные зоны рефакторинга.

## 8. Сценарии взаимодействия
- [ ] Подготовить 2–3 ключевых сквозных сценария (открытие проекта, правка требования, построение отчёта).
- [ ] Для каждого сценария описать последовательность взаимодействий между слоями.
- [ ] Определить, нужны ли диаграммы последовательностей или таблицы.

## 9. Риски и задачи
- [ ] Собрать список выявленных проблем и решений.
- [ ] Зафиксировать идеи для автоматизации (генерация диаграмм, проверка зависимостей).

> После заполнения раздела проверить, что системный контекст и данные/конфигурации содержат соответствующие ссылки.
