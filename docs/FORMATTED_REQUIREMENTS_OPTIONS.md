# План реализации: Markdown + формулы + таблицы + рисунки в требованиях

Ниже — рабочий план для варианта 1 (Markdown + Math + attachments). Это **план
работ для реализации**, рассчитанный на итерации по ~300 строк изменения кода
за один заход. Гранулярность учитывает тесты, инфраструктуру и риски.

## Как это работает для пользователя (целевое поведение)

### Основные формы и экраны

- **Редактор требования**: поле `Requirement text` остаётся основным местом
  ввода, но получает режимы:
  - **Edit** — ввод Markdown- текста;
  - **Preview** — рендер HTML с формулами/таблицами/картинками.
- **Панель вложений**: список прикреплённых файлов (attachments) с примечаниями
  и кнопками управления.

### Кнопки и действия

- **Переключатель Edit/Preview** — мгновенный просмотр форматирования.
- **Insert Image…** — открывает файловый диалог, копирует файл в assets и
  вставляет ссылку в текст.
- **DOCX formula renderer** — комбобокс выбора механизма рендера формул
  (MathML→OMML / KaTeX→MathML→OMML / SVG/PNG fallback) для экспорта в Word.
- **Attach existing…** — прикрепляет файл без вставки ссылки (на будущее, для
  общих вложений).
- **Remove attachment** — удаляет файл из списка (и опционально из assets).
- **Help ( ? ) рядом с полем текста требования** — открывает подробную справку
  о том, как формулировать требования и как использовать Markdown/формулы.

### Как хранится и отображается изображение

- При вставке изображения файл копируется в
  `requirements/<PREFIX>/assets/`.
- В список вложений добавляется запись вида:
  `{ "id": "<uuid>", "path": "assets/<file>", "note": "..." }`.
- В текст вставляется Markdown-ссылка:
  `![Описание](attachment:<id>)`.
- В Preview ссылка `attachment:<id>` разворачивается в локальный файл.

### Примеры разметки для пользователя

- **Формула (inline):** `Скорость: \\(v = s/t\\)`
- **Формула (block):**
  ```
  $$E = mc^2$$
  ```
- **Таблица:**
  ```
  | Параметр | Значение |
  |----------|----------|
  | Масса    | 12 кг    |
  ```
- **Картинка:** `![Схема](attachment:3f6c0b)`

### Справка по формулировке требований (контент кнопки Help)

**Как формулировать текст требования**

1. **Однозначность** — не использовать неопределённые слова без критериев
   (“как правило”, “по возможности”, “при необходимости”), если не задано,
   как проверить выполнение.
2. **Простота** — одно требование = одна мысль, без необходимости делить на
   части.
3. **Минимальность** — не дублировать требования и не формулировать логически
   выводимые повторы.
4. **Непротиворечивость** — требования не должны конфликтовать друг с другом в
   одинаковых условиях.
5. **Свобода реализации** — описывать “что” должно быть обеспечено, без
   деталей реализации, если они не являются неизбежным ограничением.
6. **Проверяемость** — по каждому требованию должно быть возможно однозначно
   установить выполнение или нарушение в каждой затрагиваемой ситуации.

**Как использовать Markdown/формулы**

- Заголовки, списки и таблицы допустимы, если помогают читабельности, но не
  дробят смысл требования на несколько мыслей.
- Формулы использовать для однозначного описания расчётов/ограничений.
- Ссылки на изображения оформлять как `![Описание](attachment:<id>)`.
- Избегать включения необязательных деталей реализации в форматировании.

### Поведение при экспорте

- **HTML экспорт** — сохраняет форматирование Markdown (таблицы, формулы,
  изображения) и выводится как **карточки требований**, а не таблица.
- **Экспорт в Word (DOCX)** — вставляется как **карточки требований** с
  формулами и изображениями; пользователь может напрямую вставить в Word или
  импортировать DOCX.
- **Plain text экспорт** — отдаёт человекочитаемый текст карточками без
  HTML/Markdown мусора (формулы и таблицы упрощаются).

### Варианты механизмов рендера (preview, HTML, DOCX)

**1. Markdown → HTML (preview / HTML экспорт)**
- Рендер через `python-markdown` + расширения `tables`, `fenced_code`,
  `codehilite` (если нужен подсвет кода).
- Формулы: KaTeX или MathJax поверх HTML (локальный JS, без сети).
- Защита: sanitize через `bleach` с whitelist разрешённых тегов.
- Плюсы: быстрый путь, хорошие возможности форматирования.
- Риски: XSS, необходимость строгих whitelist и тестов.

**2. Формулы для DOCX (лёгкие цепочки без тяжёлых зависимостей)**
- **MathML → OMML**: преобразование MathML в формат Word (OMML), затем вставка
  в DOCX. Нужен конвертер (например, через `mathml2omml`).
- **KaTeX → MathML → OMML**: KaTeX генерирует MathML, затем конвертация в OMML.
- **SVG/PNG формулы** (fallback): рендер формул в картинку и вставка в DOCX
  как изображение (хуже для копирования/поиска).
- Плюсы: OMML — нативный формат Word; изображения проще, но менее гибкие.
- Риски: конвертация формул в OMML может быть неполной; нужен выбор одной
  стабильной цепочки и тесты на набор типовых формул.

**3. Markdown → DOCX**
- Использовать `python-docx` и формировать карточки вручную (поля + блоки
  текста + формулы/картинки).
- Плюсы: `python-docx` даёт контроль структуры карточек.
- Риски: `python-docx` сложнее для формул.

## Цели и ограничения

- Поддержать легкое форматирование, формулы, таблицы и изображения в тексте
  требования (`statement`).
- Хранение требований остаётся JSON; вводимый формат — Markdown.
- Изображения хранятся как файлы, привязанные через `attachments`.
- В UI нужен режим «Редактирование/Просмотр» с безопасным рендером HTML.
- Экспорт: HTML должен уметь отображать Markdown; plain text — оставаться
  читаемым (без HTML мусора).
- **Не сохраняем обратную совместимость** по формату `statement`: считаем его
  Markdown по умолчанию. Старые тексты тоже валидны как Markdown.

---

## Итерация 1 — Схема хранения изображений и attachments (≈300 строк)

**Цель:** определить формат изображения и привязку к `attachments`.

**Шаги**

1. **Определить формат ссылок:**
   - В Markdown использовать `![alt](attachment:<id>)`.
   - В `attachments` хранить: `{ "id": "<uuid>", "path": "assets/<file>", "note": "..." }`.

2. **Хранилище файлов:**
   - Каталог: `requirements/<PREFIX>/assets/`.
   - API в `RequirementsService`: добавить методы для загрузки и получения
     изображения (по id).

3. **Валидация:**
   - Проверить уникальность `attachment.id` в пределах requirement.
   - Валидация существования файла при сохранении (опционально, настройка).

4. **Тесты (core/service):**
   - Создание requirement с attachment (id/path).
   - Проверка корректного сохранения пути.
   - Негативный тест на дубликаты id.

**Риски:**
- Коллизии id, неудобство при переносе требований между документами.
- Необходимость копирования assets при clone/move.

---

## Итерация 2 — Рендер Markdown → HTML в UI (≈300 строк)

**Цель:** сделать режим просмотра и безопасный рендер.

**Шаги**

1. **Выбор рендерера:**
   - Python-библиотека Markdown + расширения `tables`, `fenced_code`.
   - KaTeX/MathJax через HTML шаблон (локальный JS, без сети).

2. **UI:**
   - В `EditorPanel`: добавить вкладки/переключатель “Edit/Preview”.
   - Preview — `wx.html2.WebView`.

3. **Санитайз:**
   - Использовать `bleach` или аналог для whitelist HTML.
   - Разрешить таблицы, базовые inline-теги, ссылки, изображения.

4. **Тесты (gui-smoke):**
   - Создать requirement с Markdown, убедиться, что preview включает HTML.
   - Проверить, что в HTML нет `<script>` от пользователя.
   - Проверить смену рендера формул в комбобоксе экспорта DOCX (UI-поведение).

**Риски:**
- Безопасность HTML в WebView.
- Поведение KaTeX в офлайн-среде.

---

## Итерация 3 — Экспорт HTML/Plain Text (≈300 строк)

**Цель:** экспортировать форматированный текст корректно.

**Шаги**

1. **HTML экспорт (карточки требований):**
   - Генерировать HTML из Markdown через рендерер.
   - Формировать карточки требований (не таблицу), сохраняя иерархию полей.
   - Вставлять HTML как safe (без экранирования). Перепроверить безопасный
     рендер через sanitize.

2. **Word (DOCX) экспорт (карточки требований):**
   - Генерировать DOCX с карточками требований и формулами.
   - Рендер формул выбирается пользователем через комбобокс (MathML→OMML /
     KaTeX→MathML→OMML / SVG/PNG fallback).
   - Вставка изображений из assets как встроенных картинок.

3. **Plain text экспорт:**
   - Добавить преобразование Markdown → plain text.
   - Сохранить читабельность для таблиц (например, Markdown таблица → ASCII).

4. **Тесты (core):**
   - Проверить, что HTML экспорт включает таблицу.
   - Проверить DOCX экспорт на наличие формул/картинок.
   - Проверить DOCX экспорт для каждого варианта рендера формул из комбобокса.
   - Проверить plain text на отсутствие Markdown мусора.

**Риски:**
- Потеря форматирования в plain text.
- Табличные данные могут быть искажены.
- Экспорт формул в DOCX может потребовать отдельного конвертера.

---

## Итерация 4 — Поиск и превью (≈300 строк)

**Цель:** корректная индексация и отображение короткого превью.

**Шаги**

1. **Поиск:**
   - Нормализовать Markdown → plain text перед индексированием.
   - Убедиться, что фильтры и сортировки используют plain text.

2. **Превью в списках:**
   - Короткая версия `statement` без Markdown, обрезка до N символов.

3. **Тесты:**
   - Тест поиска по тексту, содержащему Markdown.
   - Тест превью.

**Риски:**
- Случайные совпадения по синтаксису Markdown.

---

## Итерация 5 — Редактирование изображений в UI (≈300 строк)

**Цель:** пользователи добавляют изображения, UI вставляет ссылку и сохраняет
attachment.

**Шаги**

1. **Диалог вставки изображения:**
   - Выбор файла.
   - Копирование в `assets/`.
   - Генерация attachment id.
   - Автоматическая вставка Markdown ссылки.

2. **Обновление attachments:**
   - Синхронизация списка attachments с текстом.
   - Очистка неиспользуемых attachments (опционально).

3. **Тесты (gui-smoke):**
   - Добавление изображения, проверка link и attachments.

**Риски:**
- Потеря ссылок при ручном редактировании Markdown.
- Сложность отслеживания удалённых картинок.

---

## Итерация 6 — Режим миграции и валидаторы (≈300 строк)

**Цель:** формализовать валидаторы и миграции; очистка легаси.

**Шаги**

1. **Миграции:**
   - При сохранении старых требований убедиться, что Markdown остаётся валидным
     и не требует специальных преобразований.
   - Удалить legacy поля/пути (если есть). (Мы не сохраняем обратную
     совместимость.)

2. **Валидация Markdown:**
   - Проверки корректности таблиц, ограничений на HTML.
   - Лимиты размера для `statement` и файлов.

3. **Тесты:**
   - Тесты миграции + негативные кейсы.

**Риски:**
- Миграция может затронуть существующие документы без явного согласия.

---

## Итерация 7 — Документация и Dev UX (≈300 строк)

**Цель:** обновить документацию и поддержку пользователей.

**Шаги**

1. **Документация:**
   - README: поддерживаемый синтаксис Markdown.
   - Примеры формул, таблиц и изображений.

2. **Локальные подсказки в UI:**
   - Tooltip с синтаксисом.

3. **Тесты:**
   - Smoke проверка по UI на отображение подсказок.

---

## Общие требования к тестам

- Изменения GUI: запускать `pytest --suite gui-smoke -q`.
- Для core/exports: `pytest --suite core -q -m "not gui"`.
- Проверить, что Markdown не ломает существующие JSON.

---

## Дополнительные задачи (если всплывут проблемы)

- Очистка "висячих" attachments (файл удалён, но ссылка осталась).
- Миграция `attachments` и `links` при копировании/переносе требования.
- Настройка конфигов (включение/отключение Markdown preview).
