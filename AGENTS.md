# AGENTS

Этот файл содержит инструкции и краткую архитектуру приложения "CookaReq".

## Общие инструкции
- Работать в основной ветке (без новых веток).
- Перед каждым коммитом выполнять `pytest`.
- Для сборки и тестов использовать системный Python 3.12.3.
  В корне лежит файл `.python-version` со значением `system`, поэтому
  `pyenv` переключается автоматически; запускать команды следует через `python3`.
  Команда `python` отсутствует, используйте `python3`.

## Архитектура

### Точка входа
- `app/main.py` — запуск приложения и создание главного окна.

### Бизнес-логика (`app/core`)
- `model.py` — dataclass `Requirement`.
- `schema.py` — JSON Schema для требований.
- `validate.py` — проверка бизнес-правил (уникальность id, обязательные поля).
- `store.py` — чтение/запись JSON, генерация имён по идентификатору.
- `search.py` — фильтрация по меткам и текстовый поиск.

### Пользовательский интерфейс (`app/ui`)
- `main_frame.py` — основное окно, меню, выбор папки.
- `list_panel.py` — список требований и фильтры/поиск.
- `editor_panel.py` — форма редактирования требований.
- `locale.py` — словарь кодов ↔ русский текст.

### Утилиты (`app/util`)
- `hashing.py` — преобразование id в короткий SHA-256 хэш.
- `paths.py` — работа с относительными путями.

### Сборка
- `build.py` — упаковка проекта через PyInstaller (one-folder).
 
## Сборка

Для создания Windows-сборки используется PyInstaller. Важно собирать в том же
окружении, где установлены все зависимости (wxPython и jsonschema), иначе в
сборку не попадут нужные пакеты.

1) Подготовьте окружение

```bash
python3 -m venv .venv
source .venv/bin/activate  # в Windows: .venv\Scripts\activate
pip install -r requirements.txt
pip install pyinstaller
```

2) Соберите приложение (режим one-folder по умолчанию)

```bash
python3 build.py
```

Готовые файлы появятся в каталоге `dist/CookaReq`. Этот вариант
самодостаточный: папка содержит все нужные DLL/библиотеки.

3) Альтернатива: один файл (one-file)

```bash
python3 build.py --onefile
```

Будет создан `CookaReq.exe`, который при запуске распаковывается во временную
папку. Такой EXE также самодостаточный и не зависит от установленных модулей в
системе.

Примечание: если при запуске EXE видите `ModuleNotFoundError: No module named 'wx'`,
значит wxPython не был установлен в окружении, в котором выполнялся `build.py`.
Убедитесь, что выполняли сборку из активированного venv с установленными
зависимостями (см. шаг 1).

## Тестирование

Чтобы прогонять тесты GUI без сборки wxPython из исходников, установите
готовые пакеты и зависимости из репозиториев Ubuntu:

```bash
apt-get update && apt-get install -y \
    python3-wxgtk4.0 python3-pip xvfb xauth
python3 -m venv .venv --system-site-packages
source .venv/bin/activate
pip install pytest pytest-xvfb jsonschema
pytest -q
```

`pytest-xvfb` автоматически поднимает виртуальный дисплей, поэтому окна не
появятся и тесты выполняются в headless-режиме.

## Локализация

Проект использует `gettext` и `wx.Locale`. В репозитории хранятся только
исходные `.po`‑файлы переводов. Скомпилированные каталоги `.mo` не добавляются в
git и генерируются локально.

1. Установите утилиты GNU gettext (необходима команда `msgfmt`). Например, в Ubuntu:

   ```bash
   sudo apt-get update && sudo apt-get install -y gettext
   ```

2. Скомпилируйте все переводы:

   ```bash
   python3 compile_translations.py
   ```

Скрипт сгенерирует `.mo`‑файлы рядом с соответствующими `.po`. При запуске
`build.py` компиляция выполняется автоматически, поэтому готовая сборка всегда
содержит актуальные переводы.

## Журнал выполнения
- 2025-09-10: Сформирован первоначальный план разработки (устарел).
- 2025-09-10: Создан каркас проекта.
- 2025-09-10: Добавлены утилиты.
- 2025-09-10: Реализована модель требований, схема и бизнес-валидация.
- 2025-09-10: Добавлены `.gitignore` и `pytest.ini`.
- 2025-09-11: Реализовано хранилище JSON.
- 2025-09-11: Реализованы поиск и фильтры.
- 2025-09-11: Создан каркас GUI.
- 2025-09-11: Реализован редактор требований.
- 2025-09-11: Добавлена локализация.
- 2025-09-12: Подключён словарь локализации.
- 2025-09-13: Добавлен скрипт сборки PyInstaller и инструкции.
- 2025-09-14: Удалён файл `Plan.md`; AGENTS.md переписан с актуальной архитектурой.
